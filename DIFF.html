<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>יומן אפייה — זמנים + טקסט חופשי</title>
  <style>
    :root{--b:#dcdcdc;--bg:#f6f6f6;}
    body{font-family:system-ui,-apple-system,Segoe UI,Arial; margin:10px; max-width:900px}
    h1{font-size:18px;margin:0 0 6px}
    .muted{color:#666;font-size:13px; line-height:1.35}
    .card{border:1px solid var(--b); border-radius:10px; padding:10px; background:#fff; margin:10px 0}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(52px, 74px));
      gap:6px;
      align-items:end;
    }
    label{
      display:block;
      font-size:13px;
      margin:0 0 2px;
      color:#333;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    input,select,textarea{
      width:100%;
      font-size:14px;
      padding:4px 8px;
      border:1px solid var(--b);
      border-radius:8px;
      box-sizing:border-box;
      background:#fff;
    }
    input{height:32px}
    input[readonly]{background:#fafafa}
    textarea{min-height:96px; resize:vertical; line-height:1.35}
    button{
      font-size:14px;
      padding:6px 10px;
      height:34px;
      border:1px solid var(--b);
      border-radius:8px;
      background:var(--bg);
      cursor:pointer;
    }
    button:hover{filter:brightness(0.98)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-block; padding:2px 10px; border:1px solid var(--b); border-radius:999px; font-size:13px; color:#444; background:#fff}
    .ok{color:#0a6}
    .warn{color:#b60}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid #efefef; padding:6px 8px; text-align:right; font-size:14px; vertical-align:top}
    th{background:var(--bg); font-weight:600}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .small{font-size:12.5px; color:#666}
    .linkbtn{background:#fff}
    @media (max-width: 940px){
      body{max-width:100%}
      .grid{grid-template-columns: repeat(12, minmax(46px, 1fr));}
    }
    @media print{
      .noPrint{display:none !important}
      body{max-width:none}
      .card{break-inside:avoid}
    }
  </style>
</head>
<body>
  <h1>יומן אפייה (מינימלי)</h1>
  <div class="muted">
    מזינים <b>שעות</b> (מיקס/חלוקה/שייפ/תנור). הדף מחשב <b>באלק</b> ו<b>זמן בחוץ</b>.
    טקסט חופשי לתהליך ותוצאה. נשמר בדפדפן (localStorage). אפשר ייצוא/ייבוא JSON לגיבוי.
  </div>

  <div class="card">
    <div class="grid">
      <div style="grid-column: span 3;">
        <label>תאריך אפייה</label>
        <input id="date" type="date">
      </div>
      <div style="grid-column: span 5;">
        <label>שם אפייה (חופשי)</label>
        <input id="title" type="text" placeholder="למשל: כפרי — שייפ רפוי — קראסט דק">
      </div>
      <div style="grid-column: span 2;">
        <label>משקל אחרי אפייה (g)</label>
        <input id="weight" type="number" min="0" step="1" placeholder="למשל 685">
      </div>
      <div style="grid-column: span 2;">
        <label>סטטוס</label>
        <div id="status" class="pill">—</div>
      </div>

      <div style="grid-column: span 3;">
        <label>מיקס (HH:MM)</label>
        <input id="tMix" type="time">
      </div>
      <div style="grid-column: span 3;">
        <label>חלוקה (HH:MM)</label>
        <input id="tDivide" type="time">
      </div>
      <div style="grid-column: span 3;">
        <label>שייפ (HH:MM)</label>
        <input id="tShape" type="time">
      </div>
      <div style="grid-column: span 3;">
        <label>תנור / תחילת אפייה (HH:MM)</label>
        <input id="tBake" type="time">
      </div>

      <div style="grid-column: span 4;">
        <label>באלק (חלוקה−מיקס)</label>
        <input id="durBulk" type="text" readonly>
      </div>
      <div style="grid-column: span 4;">
        <label>בחוץ (תנור−שייפ)</label>
        <input id="durOutside" type="text" readonly>
      </div>
      <div style="grid-column: span 4;">
        <label>סה״כ בחוץ</label>
        <input id="durTotalOut" type="text" readonly>
      </div>

      <div style="grid-column: span 12;">
        <label>הערות זיהוי (מתי עבר יום)</label>
        <div class="small" id="rolloverNote">—</div>
      </div>

      <div style="grid-column: span 6;">
        <label>תהליך (טקסט חופשי)</label>
        <textarea id="process" placeholder="לדוגמה: שייפ רפוי, 3 קיפולים עדינים, בצק רוטט..."></textarea>
      </div>
      <div style="grid-column: span 6;">
        <label>תוצאה (טקסט חופשי)</label>
        <textarea id="result" placeholder="לדוגמה: משקל 685g, קראסט דק, קראמב אחיד, טעם..."></textarea>
      </div>

      <div style="grid-column: span 12;" class="row noPrint">
        <button id="saveBtn" type="button">שמור אפייה</button>
        <button id="newBtn" type="button">חדש / נקה</button>
        <button id="copyBtn" type="button">העתק טקסט</button>
        <button id="exportBtn" type="button">ייצוא JSON</button>
        <label class="linkbtn">
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <button id="importBtn" type="button" class="linkbtn">ייבוא JSON</button>
        </label>
        <span class="pill">חיפוש: <input id="search" type="text" style="width:220px; height:30px; font-size:14px" placeholder="מילה/ביטוי..."></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row noPrint">
      <span class="pill" id="countPill">0 אפיות</span>
      <span class="muted">לחיצה על “טען” תפתח את האפייה לעריכה.</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:120px">תאריך</th>
          <th>שם</th>
          <th style="width:90px">משקל</th>
          <th style="width:140px">באלק</th>
          <th style="width:160px">בחוץ</th>
          <th style="width:180px" class="noPrint">פעולות</th>
        </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </div>

<script>
  const KEY = "bake_log_v1";
  const $ = (id)=>document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }

  function parseTimeToMinutes(t){
    // "HH:MM" => minutes
    if(!t || !/^\d\d:\d\d$/.test(t)) return null;
    const [h,m] = t.split(":").map(Number);
    return h*60 + m;
  }

  function fmtDur(mins){
    if(mins === null || mins === undefined) return "";
    if(mins < 0) mins = 0;
    const h = Math.floor(mins/60);
    const m = mins % 60;
    if(h === 0) return `${m} ד׳`;
    if(m === 0) return `${h} ש׳`;
    return `${h} ש׳ ${m} ד׳`;
  }

  function computeWithRollover(times){
    // times is array of {label, minutes}
    // If a later time is "earlier" than previous, assume +24h rollover.
    let noteParts = [];
    let out = [];
    let add = 0;
    let prev = null;
    for(const item of times){
      if(item.minutes === null){
        out.push({...item, minutesAdj:null, dayAdd:0});
        continue;
      }
      let cur = item.minutes;
      if(prev !== null && cur + add < prev){
        add += 24*60;
        noteParts.push(`מעבר יום לפני "${item.label}"`);
      }
      const adj = cur + add;
      out.push({...item, minutesAdj:adj, dayAdd:Math.floor(add/(24*60))});
      prev = adj;
    }
    return {out, note: noteParts.length ? noteParts.join(" • ") : "—"};
  }

  function getForm(){
    return {
      id: $("id").value || null,
      date: $("date").value || "",
      title: $("title").value || "",
      weight: $("weight").value ? Number($("weight").value) : null,
      tMix: $("tMix").value || "",
      tDivide: $("tDivide").value || "",
      tShape: $("tShape").value || "",
      tBake: $("tBake").value || "",
      process: $("process").value || "",
      result: $("result").value || "",
    };
  }

  function setForm(x){
    $("id").value = x?.id || "";
    $("date").value = x?.date || todayISO();
    $("title").value = x?.title || "";
    $("weight").value = (x?.weight ?? "") === null ? "" : (x?.weight ?? "");
    $("tMix").value = x?.tMix || "";
    $("tDivide").value = x?.tDivide || "";
    $("tShape").value = x?.tShape || "";
    $("tBake").value = x?.tBake || "";
    $("process").value = x?.process || "";
    $("result").value = x?.result || "";
    recalc();
  }

  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
    catch(e){ return []; }
  }

  function saveAll(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  function makeId(date, title, tBake){
    // deterministic-ish, but unique enough: YYYYMMDD_HHMM + short title hash
    const d = (date || todayISO()).replaceAll("-","");
    const t = (tBake || "00:00").replace(":","");
    const s = (title || "bake").trim().toLowerCase();
    let h = 0;
    for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; }
    const hh = String(Math.abs(h)).slice(0,6).padStart(6,"0");
    return `${d}_${t}_${hh}`;
  }

  function computeDurations(form){
    const tm = parseTimeToMinutes(form.tMix);
    const td = parseTimeToMinutes(form.tDivide);
    const ts = parseTimeToMinutes(form.tShape);
    const tb = parseTimeToMinutes(form.tBake);

    const {out, note} = computeWithRollover([
      {label:"מיקס", minutes: tm},
      {label:"חלוקה", minutes: td},
      {label:"שייפ", minutes: ts},
      {label:"תנור", minutes: tb},
    ]);

    const m = out[0].minutesAdj;
    const d = out[1].minutesAdj;
    const s = out[2].minutesAdj;
    const b = out[3].minutesAdj;

    const bulk = (m !== null && d !== null) ? (d - m) : null;
    const outside = (s !== null && b !== null) ? (b - s) : null;
    const totalOut = (bulk !== null && outside !== null) ? (bulk + outside) : null;

    return {bulk, outside, totalOut, note, rollover: out};
  }

  function recalc(){
    const form = getForm();
    const {bulk, outside, totalOut, note} = computeDurations(form);
    $("durBulk").value = bulk===null ? "" : fmtDur(bulk);
    $("durOutside").value = outside===null ? "" : fmtDur(outside);
    $("durTotalOut").value = totalOut===null ? "" : fmtDur(totalOut);
    $("rolloverNote").textContent = note;

    // status
    const issues = [];
    if(!form.date) issues.push("חסר תאריך");
    if(!form.title.trim()) issues.push("חסר שם");
    if(parseTimeToMinutes(form.tMix)===null) issues.push("חסר מיקס");
    if(parseTimeToMinutes(form.tDivide)===null) issues.push("חסר חלוקה");
    if(parseTimeToMinutes(form.tShape)===null) issues.push("חסר שייפ");
    if(parseTimeToMinutes(form.tBake)===null) issues.push("חסר תנור");

    $("status").innerHTML = issues.length
      ? `<span class="warn">⚠ ${issues.join(" • ")}</span>`
      : `<span class="ok">✓ מוכן לשמירה</span>`;
  }

  function toCopyText(form){
    const {bulk, outside, totalOut, note} = computeDurations(form);
    const lines = [];
    lines.push(`=== ${form.title || "אפייה"} ===`);
    lines.push(`תאריך: ${form.date || "—"}${note!=="—" ? " | " + note : ""}`);
    if(form.weight) lines.push(`משקל אחרי אפייה: ${form.weight}g`);
    lines.push("");
    lines.push(`מיקס: ${form.tMix || "—"} | חלוקה: ${form.tDivide || "—"} | שייפ: ${form.tShape || "—"} | תנור: ${form.tBake || "—"}`);
    lines.push(`באלק: ${bulk===null ? "—" : fmtDur(bulk)} | בחוץ: ${outside===null ? "—" : fmtDur(outside)} | סה״כ בחוץ: ${totalOut===null ? "—" : fmtDur(totalOut)}`);
    lines.push("");
    if((form.process||"").trim()){
      lines.push("תהליך:");
      lines.push(form.process.trim());
      lines.push("");
    }
    if((form.result||"").trim()){
      lines.push("תוצאה:");
      lines.push(form.result.trim());
      lines.push("");
    }
    return lines.join("\n");
  }

  function renderList(){
    const q = ($("search").value || "").trim().toLowerCase();
    const arr = loadAll();

    const filtered = arr.filter(x=>{
      if(!q) return true;
      const hay = [
        x.date, x.title, x.process, x.result,
        String(x.weight ?? ""),
        x.tMix, x.tDivide, x.tShape, x.tBake
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });

    $("countPill").textContent = `${filtered.length} אפיות`;

    const tb = $("listBody");
    tb.innerHTML = "";

    if(!filtered.length){
      const tr=document.createElement("tr");
      const td=document.createElement("td");
      td.colSpan=6;
      td.className="muted";
      td.textContent = "אין אפיות (או שאין תוצאות לחיפוש).";
      tr.appendChild(td);
      tb.appendChild(tr);
      return;
    }

    filtered.forEach(x=>{
      const {bulk, outside} = computeDurations(x);
      const tr=document.createElement("tr");

      const tdDate=document.createElement("td");
      tdDate.textContent = x.date || "—";

      const tdTitle=document.createElement("td");
      tdTitle.innerHTML = `<div><b>${escapeHtml(x.title || "—")}</b></div>
        <div class="small">${escapeHtml(((x.result||x.process)||"").slice(0,80))}${((x.result||x.process)||"").length>80?"…":""}</div>`;

      const tdW=document.createElement("td");
      tdW.textContent = x.weight ? (x.weight + "g") : "—";

      const tdBulk=document.createElement("td");
      tdBulk.textContent = bulk===null ? "—" : fmtDur(bulk);

      const tdOut=document.createElement("td");
      tdOut.textContent = outside===null ? "—" : fmtDur(outside);

      const tdAct=document.createElement("td");
      tdAct.className="noPrint";
      tdAct.innerHTML = `
        <button data-act="load" data-id="${x.id}">טען</button>
        <button data-act="dup" data-id="${x.id}">שכפל</button>
        <button data-act="del" data-id="${x.id}" class="linkbtn">מחק</button>
      `;

      tr.appendChild(tdDate);
      tr.appendChild(tdTitle);
      tr.appendChild(tdW);
      tr.appendChild(tdBulk);
      tr.appendChild(tdOut);
      tr.appendChild(tdAct);

      tb.appendChild(tr);
    });

    tb.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        if(act==="load") loadById(id);
        if(act==="dup") duplicateById(id);
        if(act==="del") deleteById(id);
      });
    });
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function loadById(id){
    const arr = loadAll();
    const x = arr.find(a=>a.id===id);
    if(!x) return;
    setForm(x);
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function duplicateById(id){
    const arr = loadAll();
    const x = arr.find(a=>a.id===id);
    if(!x) return;
    const copy = {...x};
    copy.id = makeId(copy.date, (copy.title||"") + " (עותק)", copy.tBake);
    copy.title = (copy.title||"") + " (עותק)";
    arr.unshift(copy);
    saveAll(arr);
    renderList();
  }

  function deleteById(id){
    if(!confirm("למחוק את האפייה?")) return;
    let arr = loadAll();
    arr = arr.filter(a=>a.id!==id);
    saveAll(arr);
    renderList();
  }

  function clearForm(){
    setForm({
      id:"",
      date: todayISO(),
      title:"",
      weight:null,
      tMix:"",
      tDivide:"",
      tShape:"",
      tBake:"",
      process:"",
      result:""
    });
  }

  function saveEntry(){
    const form = getForm();
    recalc();

    // basic validation
    const missing = [];
    if(!form.date) missing.push("תאריך");
    if(!form.title.trim()) missing.push("שם");
    if(parseTimeToMinutes(form.tMix)===null) missing.push("מיקס");
    if(parseTimeToMinutes(form.tDivide)===null) missing.push("חלוקה");
    if(parseTimeToMinutes(form.tShape)===null) missing.push("שייפ");
    if(parseTimeToMinutes(form.tBake)===null) missing.push("תנור");

    if(missing.length){
      alert("חסרים: " + missing.join(", "));
      return;
    }

    if(!form.id){
      form.id = makeId(form.date, form.title, form.tBake);
      $("id").value = form.id;
    }

    const arr = loadAll();
    const idx = arr.findIndex(a=>a.id===form.id);
    if(idx>=0) arr[idx]=form; else arr.unshift(form);
    saveAll(arr);
    $("status").innerHTML = `<span class="ok">✓ נשמר</span>`;
    setTimeout(()=>recalc(), 700);
    renderList();
  }

  async function copyText(){
    const form = getForm();
    const txt = toCopyText(form);
    try{ await navigator.clipboard.writeText(txt); }
    catch(e){ /* ignore */ }
  }

  function exportJson(){
    const arr = loadAll();
    const blob = new Blob([JSON.stringify(arr, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `bake_log_${todayISO()}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function importJsonFile(file){
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(String(reader.result||"[]"));
        if(!Array.isArray(data)) throw new Error("not array");
        // merge by id
        const cur = loadAll();
        const map = new Map(cur.map(x=>[x.id,x]));
        data.forEach(x=>{
          if(x && x.id) map.set(x.id, x);
        });
        const merged = Array.from(map.values()).sort((a,b)=>(b.date||"").localeCompare(a.date||""));
        saveAll(merged);
        renderList();
        alert("ייבוא בוצע");
      }catch(e){
        alert("קובץ לא תקין");
      }
    };
    reader.readAsText(file);
  }

  function init(){
    // hidden id field
    const hid = document.createElement("input");
    hid.type="hidden"; hid.id="id"; hid.value="";
    document.body.appendChild(hid);

    $("date").value = todayISO();
    clearForm();

    ["date","title","weight","tMix","tDivide","tShape","tBake","process","result"].forEach(id=>{
      $(id).addEventListener("input", recalc);
    });

    $("saveBtn").addEventListener("click", saveEntry);
    $("newBtn").addEventListener("click", clearForm);
    $("copyBtn").addEventListener("click", copyText);
    $("exportBtn").addEventListener("click", exportJson);
    $("importBtn").addEventListener("click", ()=>$("importFile").click());
    $("importFile").addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if(f) importJsonFile(f);
      e.target.value = "";
    });
    $("search").addEventListener("input", renderList);

    renderList();
    recalc();
  }

  init();
</script>
</body>
</html>
